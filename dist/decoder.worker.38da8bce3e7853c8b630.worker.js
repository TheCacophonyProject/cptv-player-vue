(()=>{var t={307:(t,e,n)=>{"use strict";t.exports=n.p+"54eb45c3cc5cc775fc0b.wasm"},489:()=>{},297:()=>{},895:()=>{}},e={};function n(r){var a=e[r];if(void 0!==a)return a.exports;var i=e[r]={exports:{}};return t[r](i,i.exports,n),i.exports}n.m=t,(()=>{n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e)})(),(()=>{n.p=""})(),(()=>{n.b=self.location+""})();(()=>{"use strict";let t;const e=new Array(32).fill(void 0);function a(t){return e[t]}e.push(void 0,null,!0,!1);let i=e.length;function o(t){t<36||(e[t]=i,i=t)}function s(t){const e=a(t);return o(t),e}function c(t){i===e.length&&e.push(e.length+1);const n=i;return i=e[n],e[n]=t,n}let l=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});l.decode();let u=null;function _(){return null!==u&&u.buffer===t.memory.buffer||(u=new Uint8Array(t.memory.buffer)),u}function f(t,e){return l.decode(_().subarray(t,t+e))}function d(t){const e=typeof t;if("number"==e||"boolean"==e||null==t)return`${t}`;if("string"==e)return`"${t}"`;if("symbol"==e){const e=t.description;return null==e?"Symbol":`Symbol(${e})`}if("function"==e){const e=t.name;return"string"==typeof e&&e.length>0?`Function(${e})`:"Function"}if(Array.isArray(t)){const e=t.length;let n="[";e>0&&(n+=d(t[0]));for(let r=1;r<e;r++)n+=", "+d(t[r]);return n+="]",n}const n=/\[object ([^\]]+)\]/.exec(toString.call(t));let r;if(!(n.length>1))return toString.call(t);if(r=n[1],"Object"==r)try{return"Object("+JSON.stringify(t)+")"}catch(a){return"Object"}return t instanceof Error?`${t.name}: ${t.message}\n${t.stack}`:r}let b=0,g=new TextEncoder("utf-8");const h="function"===typeof g.encodeInto?function(t,e){return g.encodeInto(t,e)}:function(t,e){const n=g.encode(t);return e.set(n),{read:t.length,written:n.length}};function w(t,e,n){if(void 0===n){const n=g.encode(t),r=e(n.length);return _().subarray(r,r+n.length).set(n),b=n.length,r}let r=t.length,a=e(r);const i=_();let o=0;for(;o<r;o++){const e=t.charCodeAt(o);if(e>127)break;i[a+o]=e}if(o!==r){0!==o&&(t=t.slice(o)),a=n(a,r,r=o+3*t.length);const e=_().subarray(a+o,a+r),i=h(t,e);o+=i.written}return b=o,a}let p=null;function y(){return null!==p&&p.buffer===t.memory.buffer||(p=new Int32Array(t.memory.buffer)),p}function m(e,n,r,a){const i={a:e,b:n,cnt:1,dtor:r},o=(...e)=>{i.cnt++;const n=i.a;i.a=0;try{return a(n,i.b,...e)}finally{0===--i.cnt?t.__wbindgen_export_2.get(i.dtor)(n,i.b):i.a=n}};return o.original=i,o}function v(e,n,r){t._dyn_core__ops__function__FnMut__A____Output___R_as_wasm_bindgen__closure__WasmClosure___describe__invoke__h58f26b25ebd66e81(e,n,c(r))}function x(e){return function(){try{return e.apply(this,arguments)}catch(n){t.__wbindgen_exn_store(c(n))}}}function k(t,e){if(!(t instanceof e))throw new Error(`expected instance of ${e.name}`);return t.ptr}function C(e,n,r,a){t.wasm_bindgen__convert__closures__invoke2_mut__h8c76bc75b4ce3cb1(e,n,c(r),c(a))}class F{static __wrap(t){const e=Object.create(F.prototype);return e.ptr=t,e}__destroy_into_raw(){const t=this.ptr;return this.ptr=0,t}free(){const e=this.__destroy_into_raw();t.__wbg_cptvplayercontext_free(e)}static newWithStream(e){var n=t.cptvplayercontext_newWithStream(c(e));return s(n)}streamComplete(){var e=t.cptvplayercontext_streamComplete(this.ptr);return 0!==e}static countTotalFrames(e){k(e,F);var n=e.ptr;e.ptr=0;var r=t.cptvplayercontext_countTotalFrames(n);return s(r)}static fetchNextFrame(e){k(e,F);var n=e.ptr;e.ptr=0;var r=t.cptvplayercontext_fetchNextFrame(n);return s(r)}totalFrames(){var e=t.cptvplayercontext_totalFrames(this.ptr);return s(e)}bytesLoaded(){var e=t.cptvplayercontext_bytesLoaded(this.ptr);return e>>>0}getNextFrame(){var e=t.cptvplayercontext_getNextFrame(this.ptr);return s(e)}getFrameHeader(){var e=t.cptvplayercontext_getFrameHeader(this.ptr);return s(e)}getWidth(){var e=t.cptvplayercontext_getWidth(this.ptr);return e>>>0}getHeight(){var e=t.cptvplayercontext_getHeight(this.ptr);return e>>>0}getFrameRate(){var e=t.cptvplayercontext_getFrameRate(this.ptr);return e}getFramesPerIframe(){var e=t.cptvplayercontext_getFramesPerIframe(this.ptr);return e}static fetchHeader(e){k(e,F);var n=e.ptr;e.ptr=0;var r=t.cptvplayercontext_fetchHeader(n);return s(r)}getHeader(){var e=t.cptvplayercontext_getHeader(this.ptr);return s(e)}}async function W(t,e){if("function"===typeof Response&&t instanceof Response){if("function"===typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(t,e)}catch(n){if("application/wasm"==t.headers.get("Content-Type"))throw n;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",n)}const r=await t.arrayBuffer();return await WebAssembly.instantiate(r,e)}{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}async function M(e){"undefined"===typeof e&&(e=new URL(n(307),n.b));const r={wbg:{}};r.wbg.__wbindgen_object_drop_ref=function(t){s(t)},r.wbg.__wbg_new_3ea8490cd276c848=function(t,e){try{var n={a:t,b:e},r=(t,e)=>{const r=n.a;n.a=0;try{return C(r,n.b,t,e)}finally{n.a=r}},a=new Promise(r);return c(a)}finally{n.a=n.b=0}},r.wbg.__wbindgen_number_new=function(t){var e=t;return c(e)},r.wbg.__wbg_newwithlength_90fbb2b2d057a3c0=function(t){var e=new Uint16Array(t>>>0);return c(e)},r.wbg.__wbindgen_memory=function(){var e=t.memory;return c(e)},r.wbg.__wbg_buffer_ebc6c8e75510eae3=function(t){var e=a(t).buffer;return c(e)},r.wbg.__wbg_newwithbyteoffsetandlength_9eb3327abeac2c52=function(t,e,n){var r=new Uint16Array(a(t),e>>>0,n>>>0);return c(r)},r.wbg.__wbg_new_68adb0d58759a4ed=function(){var t=new Object;return c(t)},r.wbg.__wbg_set_2e79e744454afade=function(t,e,n){a(t)[s(e)]=s(n)},r.wbg.__wbindgen_string_new=function(t,e){var n=f(t,e);return c(n)},r.wbg.__wbg_new_59cb74e423758ede=function(){var t=new Error;return c(t)},r.wbg.__wbg_stack_558ba5917b466edd=function(e,n){var r=a(n).stack,i=w(r,t.__wbindgen_malloc,t.__wbindgen_realloc),o=b;y()[e/4+1]=o,y()[e/4+0]=i},r.wbg.__wbg_error_4bb6c2a97407129a=function(e,n){try{console.error(f(e,n))}finally{t.__wbindgen_free(e,n)}},r.wbg.__wbg_read_2516fe8e4e56274e=x((function(t){var e=a(t).read();return c(e)})),r.wbg.__wbg_then_ac66ca61394bfd21=function(t,e,n){var r=a(t).then(a(e),a(n));return c(r)},r.wbg.__wbindgen_boolean_get=function(t){const e=a(t);var n="boolean"===typeof e?e?1:0:2;return n},r.wbg.__wbindgen_is_undefined=function(t){var e=void 0===a(t);return e},r.wbg.__wbg_instanceof_Uint8Array_d7349a138407a31e=function(t){var e=a(t)instanceof Uint8Array;return e},r.wbg.__wbg_byteLength_7d55aca7ec6c42cb=function(t){var e=a(t).byteLength;return e},r.wbg.__wbg_length_317f0dd77f7a6673=function(t){var e=a(t).length;return e},r.wbg.__wbg_new_135e963dedf67b22=function(t){var e=new Uint8Array(a(t));return c(e)},r.wbg.__wbg_set_4a5072a31008e0cb=function(t,e,n){a(t).set(a(e),n>>>0)},r.wbg.__wbg_cptvplayercontext_new=function(t){var e=F.__wrap(t);return c(e)},r.wbg.__wbg_call_f5e0576f61ee7461=x((function(t,e,n){var r=a(t).call(a(e),a(n));return c(r)})),r.wbg.__wbg_get_0c6963cbab34fbb6=x((function(t,e){var n=Reflect.get(a(t),a(e));return c(n)})),r.wbg.__wbg_new_7031805939a80203=function(t,e){var n=new Error(f(t,e));return c(n)},r.wbg.__wbindgen_object_clone_ref=function(t){var e=a(t);return c(e)},r.wbg.__wbindgen_debug_string=function(e,n){var r=d(a(n)),i=w(r,t.__wbindgen_malloc,t.__wbindgen_realloc),o=b;y()[e/4+1]=o,y()[e/4+0]=i},r.wbg.__wbindgen_throw=function(t,e){throw new Error(f(t,e))},r.wbg.__wbg_then_367b3e718069cfb9=function(t,e){var n=a(t).then(a(e));return c(n)},r.wbg.__wbindgen_cb_drop=function(t){const e=s(t).original;if(1==e.cnt--)return e.a=0,!0;var n=!1;return n},r.wbg.__wbg_resolve_778af3f90b8e2b59=function(t){var e=Promise.resolve(a(t));return c(e)},r.wbg.__wbg_debug_3c0b82934d1dd91e=function(t){console.debug(a(t))},r.wbg.__wbg_error_9ff84d33a850b1ef=function(t){console.error(a(t))},r.wbg.__wbg_info_3b2058a219fa31b9=function(t){console.info(a(t))},r.wbg.__wbg_log_386a8115a84a780d=function(t){console.log(a(t))},r.wbg.__wbg_warn_5fc232d538408d4a=function(t){console.warn(a(t))},r.wbg.__wbindgen_closure_wrapper211=function(t,e,n){var r=m(t,e,49,v);return c(r)},("string"===typeof e||"function"===typeof Request&&e instanceof Request||"function"===typeof URL&&e instanceof URL)&&(e=fetch(e));const{instance:i,module:o}=await W(await e,r);return t=i.exports,M.__wbindgen_wasm_module=o,t}const A=M;var S=n(489),U=n(297);class P{constructor(){this.fn=null}unlock(){this.fn&&this.fn()}}const T=function(t,e){const n={offsets:[]};n.bytes=t,n.offset=0;const r=t.byteLength;let a=5;0!==e&&(a=Math.ceil(r/e));const i=r/a;for(let o=0;o<a;o++)n.offsets.push(Math.ceil(i*o));return n.offsets.push(r),{read(){return new Promise((t=>{n.offset+=1;const e=n.bytes.slice(n.offsets[n.offset-1],n.offsets[n.offset]);t({value:e,done:n.offset===n.offsets.length-1})}))},cancel(){return new Promise((t=>{t()}))}}};let H=!1;class L{async initWithCptvUrlAndSize(t,e){const n=new P;await this.lockIsUncontended(n),this.locked=!0,H?H&&this.inited&&(this.playerContext.free(),this.reader&&await this.reader.cancel()):(await A(),H=!0);try{if(this.consumed=!1,this.response=await fetch(t),200===this.response.status)return this.reader=this.response.body.getReader(),e||(e=Number(this.response.headers.get("Content-Length"))||0),this.expectedSize=e,this.playerContext=await F.newWithStream(this.reader),n.unlock(),this.inited=!0,this.locked=!1,!0;this.locked=!1;try{const t=await this.response.json();return t.messages&&t.messages.pop()||t.message||"Unknown error"}catch(a){return await r.text()}}catch(a){return this.locked=!1,`Failed to load CPTV url ${t}, ${a}`}}async initWithCptvFile(t){const e=await S.readFile(t),n=(0,U.createRequire)("file:///Users/jon/Dev/Cacophony/cptv-player-vue/node_modules/cptv-decoder/decoder.js"),r=n.resolve("./pkg/index_bg.wasm"),a=await S.readFile(r);return this.initWithFileBytes(e,t,a)}async initWithFileBytes(t,e="",n){const r=new P;await this.lockIsUncontended(r),this.locked=!0,H?H&&this.inited&&(this.playerContext.free(),this.reader&&await this.reader.cancel()):(await A(n),H=!0),this.consumed=!1,this.reader=new T(t,1e5),this.expectedSize=t.length;try{return this.playerContext=await F.newWithStream(this.reader),r.unlock(),this.inited=!0,this.locked=!1,!0}catch(a){return this.locked=!1,`Failed to load CPTV file ${e}, ${a}`}}async fetchNextFrame(){if(!this.reader)return"You need to initialise the player with the url of a CPTV file";if(this.consumed)return"Stream has already been consumed and discarded";const t=new P;await this.lockIsUncontended(t),this.locked=!0,this.playerContext&&this.playerContext.ptr&&(this.playerContext=await F.fetchNextFrame(this.playerContext)),t.unlock(),this.locked=!1;const e=this.playerContext.getNextFrame();if(0===e.length)return null;const n=this.playerContext.getFrameHeader();return{data:new Uint16Array(e),meta:n}}async countTotalFrames(){if(!this.reader)return"You need to initialise the player with the url of a CPTV file";const t=new P;return await this.lockIsUncontended(t),this.locked=!0,this.playerContext&&this.playerContext.ptr&&(this.playerContext=await F.countTotalFrames(this.playerContext),this.consumed=!0),t.unlock(),this.locked=!1,this.getTotalFrames()}async getMetadata(){const t=await this.getHeader(),e=await this.countTotalFrames(),n=1/t.fps*e;return{...t,duration:n}}async getFileMetadata(t){return await this.initWithCptvFile(t,!0),await this.getMetadata()}async getStreamMetadata(t,e){return await this.initWithCptvUrlAndSize(t,e),await this.getMetadata()}async lockIsUncontended(t){return new Promise((e=>{this.locked?t.fn=e:e()}))}async getHeader(){if(!this.reader)return"You need to initialise the player with the url of a CPTV file";const t=new P;await this.lockIsUncontended(t),this.locked=!0,this.playerContext&&this.playerContext.ptr&&(this.playerContext=await F.fetchHeader(this.playerContext));const e=this.playerContext.getHeader();return t.unlock(),this.locked=!1,e}getTotalFrames(){return!this.locked&&this.inited&&this.playerContext.ptr&&this.playerContext.streamComplete()?this.playerContext.totalFrames():null}getLoadProgress(){return!this.locked&&this.playerContext&&this.playerContext.ptr?this.playerContext.bytesLoaded()/this.expectedSize:null}}var I=n(895);const R=I.parentPort||"undefined"!==typeof self&&self;if(R){const t=new L;R.addEventListener("message",(async({data:e})=>{switch(e.type){case"initWithUrl":{const n=await t.initWithCptvUrlAndSize(e.url);R.postMessage({type:e.type,data:n})}break;case"initWithUrlAndSize":{const n=await t.initWithCptvUrlAndSize(e.url,e.size);R.postMessage({type:e.type,data:n})}break;case"initWithPath":{const n=await t.initWithCptvFile(e.path);R.postMessage({type:e.type,data:n})}break;case"initWithLocalCptvFile":{const n=await t.initWithFileBytes(e.arrayBuffer);R.postMessage({type:e.type,data:n})}break;case"getFileMetadata":{const n=await t.getFileMetadata(e.path);R.postMessage({type:e.type,data:n})}break;case"getStreamMetadata":{const n=await t.getStreamMetadata(e.url);R.postMessage({type:e.type,data:n})}break;case"getNextFrame":{const n=await t.fetchNextFrame();R.postMessage({type:e.type,data:n})}break;case"getTotalFrames":{const n=t.getTotalFrames();R.postMessage({type:e.type,data:n})}break;case"getLoadProgress":{const n=t.getLoadProgress();R.postMessage({type:e.type,data:n})}break;case"getHeader":{const n=await t.getHeader();R.postMessage({type:e.type,data:n})}break;default:return void R.postMessage(e)}}))}})()})();
//# sourceMappingURL=decoder.worker.38da8bce3e7853c8b630.worker.js.map